#!/usr/bin/env bash

# Update local dev environment using ansible-playbook.
# Optionally pass role names to limit run
#
# 1. Sync any updates from git
# 2. Runs ansible to apply any changes

set -e

# change to parent directory of the directory containing the currently executing bash script.
cd "${BASH_SOURCE%/*}/.."

git pull origin master

join() {
    IFS="$1"
    shift
    echo "$*"
}

cd ./ansible

if [[ $# -gt 0 ]]; then
    tags="--tags=$(join , $@)"

    echo "Updating local dev environment... (--tags $@)"
    ansible-playbook \
      --extra-vars whoami="$(whoami)" \
      --extra-vars whoami_group="$(id -gn)" \
      --skip-tags "bootstrap" --tags $@ \
      --ask-become-pass \
      dotfiles.yml  
else
    # Run all roles except for the ones tagged with 'bootstrap'
    echo "Updating local dev environment..."
    ansible-playbook \
      --skip-tags "bootstrap" \
      --ask-become-pass \
      dotfiles.yml  
fi
